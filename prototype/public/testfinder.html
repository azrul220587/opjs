<!doctype html>
<html>
<head>
  <title>Test Finder</title>
  <style>
  form {
  width:300px;
}

input {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  border:1px solid #ccc;
  font-size:20px;
  width:300px;
  min-height:30px;
  display:block;
  margin-bottom:15px;
  margin-top:5px;
  outline: none;

  -webkit-border-radius:5px;
  -moz-border-radius:5px;
  -o-border-radius:5px;
  -ms-border-radius:5px;
  border-radius:5px;
}

input[type=submit] {
  background:none;
  padding:10px;
}
</style>
</head>
<body>
<script src="scripts/lib/require.js"></script>
<script>
(typeof define=="function"&&function(e){define("dombuilder",e)}||function(e){window.domBuilder=e()})(function(){"use strict";function e(n,a){if(typeof n=="string")return document.createTextNode(n);var f,l;for(var c=0,h=n.length;c<h;c++){var p=n[c];if(!f){if(typeof p=="string"){var d=p.match(o);d=d?d[0]:"div",f=document.createElement(d),l=!0;var v=p.match(r);v&&f.setAttribute("class",v.map(u).join(" "));var m=p.match(i);m&&f.setAttribute("id",m[0].substr(1));var g=p.match(s);a&&g&&(a[g[0].substr(1)]=f);continue}f=document.createDocumentFragment()}l&&typeof p=="object"&&p.__proto__===Object.prototype?t(f,p):f.appendChild(e(p,a)),l=!1}return f}function t(e,t){var r=Object.keys(t);for(var i=0,s=r.length;i<s;i++){var o=r[i],u=t[o];o==="$"?u(e):o==="css"?n(e.style,u):o.substr(0,2)==="on"?e.addEventListener(o.substr(2),u,!1):e.setAttribute(o,u)}}function n(e,t){var n=Object.keys(t);for(var r=0,i=n.length;r<i;r++){var s=n[r];e[s]=t[s]}}function u(e){return e.substr(1)}var r=/\.[^.#$]+/g,i=/#[^.#$]+/,s=/\$[^.#$]+/,o=/^[^.#$]+/;return e});

require.config({
  baseUrl: 'scripts',
  paths: {
    q: 'lib/q',
    transport: 'modules/transport'
  },
  shim: {
    transport: {
      deps: ['q'],
    }
  }
});
require(['transport', 'dombuilder', 'q'], function (Transport, domBuilder, Q) {

  function githubLogin() {
    var deferred = new Q.defer();
    document.body.appendChild(domBuilder([
      ["button", {onclick: function (evt) {
        var child = window.open('https://github.com/login/oauth/authorize'
          + '?client_id=' + client_id
          + '&state=' + id, "github_oauth", "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,width=960,height=640");
        var button = this;
        child.addEventListener('message', function (evt) {
          evt.preventDefault();
          evt.stopPropagation();
          document.body.removeChild(button);
          var data = evt.data;
          if (data.error) {
            return deferred.reject(data.error);
          }
          deferred.resolve(data);
        }, false);
      }}, "Log in using Github..."]
    ]));
    return deferred.promise;
  }

  function aprompt(label, action) {
    var deferred = new Q.defer();
    document.body.appendChild(domBuilder([
      ['form', {onsubmit: function (evt) {
        deferred.resolve(this.value.value);
        evt.preventDefault();
        evt.stopPropagation();
        document.body.removeChild(this);
      }},
        ['label', label],
        ['input', {name: 'value', autofocus: true}],
        ['input', {type: 'submit', value: action}]
      ]
    ]));
    return deferred.promise;
  }

  document.body.textContent = '';
  var url = window.location.toString().replace(/^http/, 'ws');
  var transport = new Transport({
    'invite': function (request, transport) {
      return {
        blob: (Math.random() * 0x100000000).toString(32)
      };
    },
    'update': function (request, transport) {
      console.log(request);
      throw new Error("TODO: Implement update");
    }
  });

  var id = document.cookie.match(/session_id=([^;]*)/)[1];
  var client_id = document.cookie.match(/client_id=([^;]*)/)[1];

  transport.open(new WebSocket(url))
  .then(function (result) {
    return githubLogin();
  })
  .then(function (session) {
    console.log('SESSION', session);
    return aprompt('Friendname:', 'Call Friend');
  })
  .then(function (friendname) {
    var blob = (Math.random() * 0x100000000).toString(32);
    return transport.peerLocationFind(friendname, blob);
  })
  .then(function (reply) {
    console.log("find-reply!", reply);
  })
  .fail(function (err) {
    throw err;
  });
});
</script>
</body>
</html>
